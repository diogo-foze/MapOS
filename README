NOTE - this is untested and probably unstable.
Pull requests are welcome - I recognise that the code needs some work.